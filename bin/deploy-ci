#!/usr/bin/env bash
set -euxo pipefail
cd "$(dirname $(dirname "$0"))"

store="s3://styx-1/nixcache/?region=us-east-1&compression=zstd&parallel-compression=true"
charon=$(nix-build ci --no-out-link -A charon)

nix store sign -v --key-file keys/styx-nixcache-test-1.secret $(nix-store -qR "$charon")
nix copy -v --to "$store" "$charon"

export TF_VAR_charon_store=$store
export TF_VAR_charon_storekey=$(cat keys/styx-nixcache-test-1.public)
export TF_VAR_charon_storepath=$charon
# TODO: get rid of target again
terraform -chdir=tf apply -target aws_autoscaling_group.charon_asg -target aws_launch_template.charon_worker
