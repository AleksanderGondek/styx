#!/usr/bin/env bash

set -eux

chunks=$(mktemp -d -p /dev/shm chunks.XXXXXXXXX)

for a; do
  tmp=$(mktemp -p /dev/shm roundtrip.XXXXXXXXX)
  nix-store --dump "$a" > ${tmp}.nar
  if ./styx debug nartomanifest --chunklocaldir $chunks ${tmp}.nar ${tmp}.man; then
    if ./styx debug manifesttoerofs --rchunklocaldir $chunks ${tmp}.man ${tmp}.ero; then
      mkdir ${tmp}.dir
      fsck.erofs -d5 ${tmp}.ero --extract=${tmp}.dir
      diff -ur --no-dereference "$a" ${tmp}.dir
    fi
  fi

  rm -rf ${tmp}{,.nar,.man,.ero,.dir}
done

du -sbc $chunks
rm -rf $chunks
